```toc
```

[SRE面试题分享](https://blog.csdn.net/qq_29974229/article/details/127899727)
[# 字节跳动蚂蚁金服百度SRE社招面经](https://blog.csdn.net/CCIEHL/article/details/104151990)

#### 1. LVS中如何解决TCP长连接导致的负载不均衡问题？
- 优化调度算法，入最小连接数、原地址哈希等
- 调整tcp连接超时时间
#### 2. 假设你们服务的 CPU usage 飙高但请求数无明显上升，你怎么排查？
-  确认影响范围：单个pod/实例？全部？
- 确认现象：CPU usage逐渐攀升？突然升高？
- 观察其他指标，内存
- 应用层：`top`查占CPU高的进程
- 系统层：`vmstat`查是否有频繁的上下文切换线程爆炸
- 容器/平台层：容器是否频繁重启
- 依赖层：阻塞调用未超时导致线程积压（数据库、缓存）
>`vmstat`: 系统级资源监控
>`dmesg`: 系统内核问题

#### 3. 假设Xiaomi App Store在“双十一”期间因某个促销API的缓存击穿，导致数据库连接池耗尽，整个服务链崩溃？
- 止损方案：降级，限流，熔断
	- 降级
		- 静态资源降级，返回兜底信息
	- 限流
		- 限制对API的访问速率，例如用nginx的`limit_req_zone`
		- 对有刷量行为的UA和IP限流，例如用nginx的`limit_req`
		>[nginx针对ip限流](https://blog.csdn.net/weixin_46615478/article/details/137189437)
	- 熔断
		- 熔断非核心请求
		- 熔断对数据库的访问保护链接池
	- 扩容
		- 快速横向扩容服务副本、DB 读实例或缓存节点
- 如何避免？或降低影响？
	- 修复缓存/缓存预热：手动或脚本补充热点key的缓存
	- 多级缓存：本地缓存 + redis + DB
	- 资源隔离：不同服务使用独立DB连接池
	- DB采用读写分离架构，i.e. 主从
	- 容灾演练：缓存失效场景、压测探索性能瓶颈
#### 4. LVS在峰值流量场景下出现CPU软中断过高？
- 定位
	- `top`运行后接着按`1`，可以显示所有CPU核心，其中si是CPU在软中断上的使用率![[Pasted image 20250517170709.png]]
	- `watch -d cat /proc/softirqs`查看软中断类型和变化速率，定位到软中断的来源
	>共10种软中断类型：HI，TIMER（定时中断），NET_TX（网络发送中断），NET_RX（网络接收中断），BLOCK，BLOCK_IPLOLL, TASKLET, SCHED（内核调度中断）, HRTIMER, RCU
	
	-  如果发现`NET_RX`变化速率快，可以用`sar -n DEV`查看各网卡接包速率情况 ==> 看哪个网卡有大量的网络包进来，接着用`tcpdump`抓包分析请求来源，考虑是否加防火墙
#### 5. 如果给你1个月时间和10台物理机，你会如何验证你设计的容灾方案能承受字节跳动‘双十一’流量？
- 将线上流量和资源等比缩放至几台物理机中，其中有x台用来发压
- 验证内容：
	- 全链路压测 --> 容量、扩容能力
	- 核心服务、组件不可用 --> 降级、限流、熔断
	- 监控告警
#### 6. 假设电商业务要求“搜索服务”99.99%可用性，但依赖的“推荐服务”团队仅承诺99.9% SLA。如何设计架构确保搜索SLO达标？
- 降低对下游的依赖：解耦 + 降级 + 缓存 + 异步
	- 解耦
		- 推荐服务异常、超时时，自动走降级逻辑而不抛出异常
	- 降级
		- 返回兜底内容、热门推荐
		- 单独部署轻量版推荐服务，故障时fallback到本地模型
	- 缓存
		- 加本地缓存 ==> 短时抗抖
	- 异步
		- 如搜索结果页加载时先展示主搜索结果，再异步拉推荐服务数据，即使推荐服务异常/响应慢也不阻塞主流程
	- 多路推荐：不仅依赖一个推荐服务
#### 7. 局域网内两台机器ping不通
- 检查iptables或防火墙，防火墙规则可能禁ping（阻止CMP协议）
- 网络配置错误
	- IP地址不属于同一个子网内
- 路由器配置错误，路由器硬件故障（电源故障、接口损坏）
- 物理连接故障，网线损坏、网卡故障
#### 8. 将SLA从99.9提高至99.99，需要做什么
- 先分析当前SLA的影响因素有哪些，造成事故、故障响应/定位、故障恢复
	- 自身服务不稳定、宕机
	- 下游依赖故障影响，依赖组件
	- 上线代码bug，代码质量差
	- 高峰期容量不足
	- 网络抖动，DNS异常
	- 偶发超时
	- 定位问题慢
	- 故障恢复慢
	- 对故障感知不及时，监控告警缺失
- 架构优化
	- 降低对下游的依赖：降级 + 隔离 + 熔断 + 缓存
	- 高可用架构：多AZ部署，负载均衡，健康检查，自动摘除，弹性扩缩
	- 核心指标监控、告警，对告警降噪
	- SOP
	- 日常容灾演练
	- 质量体系建设：自动化测试 + CICD（分级发布，快速回滚）
- 团队组织配合
	- 指定上线熔断规则，用完错误预算后禁止迭代
#### 9. 公司的服务部署在国内，打算在美国访问过来，觉得要弄什么措施？
- CDN
- 部署中美之间的中转节点，如美国请求-->新加坡nginx-->中国服务
#### 10. 机器的磁盘满了，删日志没有反应，可能是什么问题？
- 文件从目录消失，但空间未释放 ==> 重启进程
``` shell
# 超着被删除仍被进程占用的文件，重启该进程
lsof -np | grep deleted
```
- 文件系统未及时更新元数据，如删除的是大文件 ==> 强制同步文件系统
``` shell
# 现象是df显示空间未变但du已减少
df -h /  # 查看文件系统层面空间
du -sh /var/log/*  # 计算目录实际占用

sync
```
- 日志文件被硬链接，删除原文件后硬链接副本仍占用空间 ==> 删除硬链接
``` shell
ls -li /app.log  # 输出的第二列数字为链接数，>1则表示存在硬链接

find / -samefile /app.log -delete
```
#### 11. 如何排查一个cpu利用率高的服务？
- 先用`top`找到吃CPU的进程，可以接着用`vmstat 1`看进程在做什么工作
>`us`（用户态）高 → 说明在跑业务逻辑
`sy`（系统态）高 → 说明系统调用多
`wa`（I/O wait）高 → 说明卡在磁盘或网络
`id`（空闲）低 → 说明机器确实被打满
- 用`sudo pstack <pid>`查看调用栈，看是否有循环、死锁等
- 最后对应看业务代码定位问题
#### 12. 某SaaS平台因一个大客户（租户A）的突发流量，导致其他租户API延迟飙升。你如何快速定位并解决问题？

#### 13. 性能雪崩，某次促销活动导致数据库CPU100%，监控显示QPS仅增长20%，如何分析？
- 隐藏陷阱：慢查询，锁竞争，连接池耗尽
#### 14. 如何为SaaS平台设计租户级API限流，支持动态调整配额（如VIP租户临时扩容）？
- 网关/代理配置限流
- 动态下发配置参数
- 弹性扩缩容
#### 15. SaaS的多租户隔离
- 隔离层次
	- 基础设施隔离 ==> 互相之间不会因为资源竞争而受到影响
		- 计算资源（CPU，内存），存储资源（数据库，文件系统），网络资源（IP，带宽）
	- 组织权限隔离 ==> 不会因为其他租户的操作而发生冲突
		- 组织信息，账号，角色，产品授权关系
	- 业务数据隔离
- 隔离模式
	- 竖井隔离：每个租户运行在独立的资源环境中
	- 共享模式：多租户共享一套基础设施资源
	- 分域隔离模式：普通客户使用共享模式，KA客户使用竖井隔离

#### 16. 如何设计一个支持全球用户访问的分布式系统？
> 高可用，高性能，易扩展
- 多Region多AZ部署
	- 如果各region之间数据同步，注意主从数据一致性问题
	- 如果因为数据合规，各地数据本地化存储，注意识别请求来源
- 请求入口
	- DNS就近解析，故障节点摘除
	- 使用CDN
	- 可以对域名做区域化管理，不同地区请求不同分区域名-->对应后端
	- 或同一域名入口，但实现跨区转发逻辑
- 容量管理，弹性扩缩
- 降级限流熔断能力
#### 17. 异地多活
- [# 搞懂异地多活，看这篇就够了](http://kaito-kidd.com/2021/10/15/what-is-the-multi-site-high-availability-design/)
- [高可用架构之异地多活](https://www.cnblogs.com/88223100/p/High-availability-architecture-with-multiple-activities-in-different-locations.html "发布于 2023-10-16 08:31")
- [高可用篇之异地多活异地双活入门介绍](https://houbb.github.io/2024/09/13/dis-active-01-overview)
#### 18. SaaS vs MSP
- 在某些领域，MSP 开始的时候可能会与 SaaS 重叠。如果 MSP 本质上要求所有客户运行相同的版本，而且**MSP 能够通过一种体验对所有租户集中加入、管理、运营和计费，那可能开始的时候更像是 SaaS 而不是 MSP**
#### 19. 跨区域数据传输的成本高，怎么优化？
- 缓存
- 压缩body，gzip
- 使用http2.0（压缩头部和body，使用二进制）
- DNS就近
#### 20. 监控项
- 域名
	- QPS，后端服务可用性（仅5xx），服务可用性（5xx+部分4xx）
	- 各状态码计数，请求时延，平均响应包体大小，后端请求时延，后端请求数
- LB
	- 出入带宽利用率，每秒丢包数，转发延迟，连接数
- 主机
	- CPU利用率，每个core利用率，内存使用率，磁盘容量
	-连接数，出入网bits数，主机QPS
	- TCP重传，TCP listen_drop和overflow
#### 21. 网络优化
-  TTL DNS
- HTTPDNS
- 多种DNS解析并行
- server提前做DNS解析，将ip_list下发给客户端
- 使用CDN
- 用ECC证书替换RSA
- RTT握手优化（tls1.2-->tls1.3）
- 协议优化，HTTP1/2/3
- 网络请求优化
	- 合并请求
	- 接口拆分
	- 多级缓存
	- 预链接
- 服务端优化
	- 删掉无用的字段处理，并行处理 ==> 提高接口性能
	- 精简处理逻辑
    - 框架升级
    - 响应压缩算法